<!-- <!DOCTYPE html>
<html>
    <head>
        <h1>This is Heading 1</h1>
        <h2>This is Heading 1</h2>
        <h3>This is Heading 1</h3>
        <h4>This is Heading 1</h4>
        <h5>This is Heading 1</h5>
        <h6>This is Heading 1</h6>
    </head>
    <body>
        <a href="https://www.google.com/search?q=google&rlz=1C1CHBD_enIN1158IN1158&oq=google&gs_lcrp=EgZjaHJvbWUyDwgAEEUYORiDARixAxiABDINCAEQABiDARixAxiABDIKCAIQABixAxiABDINCAMQABiDARixAxiABDINCAQQABiDARixAxiABDINCAUQABiDARixAxiABDIKCAYQABixAxiABDINCAcQABiDARixAxiABDIKCAgQABixAxiABDIKCAkQABixAxiABNIBCTI0NzRqMGoxNagCCLACAfEFMGB1a-u3sNo&sourceid=chrome&ie=UTF-8">Click Here</a>
        <ul>
            <li>Maggi</li>
            <li>Kurkure</li>
            <li>Lays</li>
        </ul>

        <ol>
            <li>Paani garam kro</li>
            <li>Chai patti dalo</li>
            <li>Chai peelo</li>
        </ol>
       
       <img src ="https://www.google.com/imgres?imgurl=https://m.media-amazon.com/images/M/MV5BNTk1OTUxMzIzMV5BMl5BanBnXkFtZTcwMzMxMjI0Nw@@._V1_FMjpg_UX1000_.jpg&tbnid=yOOQBUXo61z3UM&vet=1&imgrefurl=https://www.imdb.com/name/nm0000821/mediaindex/&docid=sK8gI92mikzGZM&w=1000&h=1374&source=sh/x/im/m5/1&kgs=6b3070b17760b8e1&shem=isst,vivsdl&utm_source=isst,vivsdl,sh/x/im/m5/1" alt="Amitabh Bachhan">     
        <p>Lorem <b>ipsum</b> dolor <s>sit</s> amet consectetur adipisicing elit. Ducimus, expedita, magni perferendis asperiores quo provident ex, voluptatibus magnam doloribus eius ipsa odio. Dicta sapiente dolores velit non deserunt, voluptatum totam nihil ipsam alias odit quis! Odio natus illum assumenda rem optio incidunt reprehenderit dolore. Ab totam deserunt unde vitae accusamus!</p>

        <p><em>Lorem</em>ipsum dolor sit, amet consectetur adipisicing elit. Aperiam facilis adipisci cupiditate consequatur perspiciatis necessitatibus explicabo minus, repudiandae doloribus aliquam, nostrum et illo odit officia quam ratione tempore corrupti consequuntur esse nesciunt optio incidunt? Repellat nemo deleniti nobis. Mollitia dolore eaque iste, id omnis quas, sit aspernatur neque dolores aut quidem temporibus incidunt optio quae cumque exercitationem quos libero? Iure impedit nulla vero eaque quae nostrum perspiciatis dolorem nesciunt, possimus distinctio placeat cum aperiam facere animi asperiores minus suscipit. Architecto, ullam! Deleniti dolorem exercitationem architecto odio pariatur sint, dolor iure autem sapiente eos, nobis praesentium. Laboriosam nesciunt doloribus quas! Ratione!</p>
    </body>
    <!DOCTYPE html>
<html>
    <table>
    <tr>
        <td>Student ID</td>
        <td>Student Name</td>
        <td>Gendre</td>
        <td>Age</td>
        <tr>
            <td>1234</td>
            <td>Bill</td>
            <td>Male</td>
            <td>17</td>
        </tr>
        <tr>
            <td>1235</td>
            <td>John</td>
            <td>Male</td>
            <td>18</td>
        </tr>
        <tr>
            <td>1236</td>
            <td>Chima</td>
            <td>Female</td>
            <td>17</td>
        </tr>
        <tr>
            <td>1237</td>
            <td>Mus</td>
            <td>Female</td>
            <td>19</td>
        </tr>
    </tr>
    </table>
    <table style border = 1>
        <tr>
            <td>Column 1</td>
            <td>Column 2</td>
            <td>Column 3</td>
        </tr>
        <tr>
        <td rowspan = 2>Row 1 Cell 1</td>
        <td>Row 1 Cell 2</td>
        <td>Row 1 Cell3</td>
        </tr>
        <tr>
            <td>Row 2 Cell 2</td>
            <td>Row 2 Cell 3</td>
        </tr> 
        <tr>
            <td colspan = 3>Row 3 Cell 1</td>
        </tr>
    </table>
</br>
    <table border = 1>
        <tr>
            <td>No.</td>
            <td>Full Name</td>
            <td>Positions</td>
            <td>Salary</td>
            <td>Type</td>
        </tr>
        <tr>
            <td>1</td>
            <td>Bill Gates</td>
            <td>Founder Microsoft</td>
            <td>$1000</td>
            <td rowspan = 4>Company Founder</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Steve Jobs</td>
            <td>Founder Apple</td>
            <td>$1200</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Larry Page</td>
            <td>Founder Google</td>
            <td>$1100</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Mark Zuckeberg</td>
            <td>Founder Facebook</td>
            <td>$1300</td>
        </tr>
        <tr>
            <td colspan="3">Total Expense</td>
            <td>$4600</td>
        </tr>
    </table>
</br>
</br>
    <table border = 1>
        <tr>
            <td>Country</td>
            <td>State</td>
            <td>City</td>
            <td>Street</td>
            <td>Male</td>
            <td>Female</td>
            <td>Others</td>
        </tr>
        <tr>
            <td rowspan="8">1</td>
            <td rowspan="4">Kerala</td>
            <td rowspan="2">Cochin</td>
            <td>New Street</td>
            <td>500</td>
            <td>600</td>
            <td>6</td>
        </tr>
        <tr>
            <td>Main Street</td>
            <td>300</td>
            <td>288</td>
            <td>2</td>
        </tr>
        <tr>
            <td rowspan="2">Trivandrum</td>
            <td>Guru Street</td>
            <td>500</td>
            <td>600</td>
            <td>10</td>
        </tr>
        <tr>
            <td>TVK Street</td>
            <td>500</td>
            <td>600</td>
            <td>2</td>
        </tr>
        <tr>
            <td rowspan="4">Maharastra</td>
            <td rowspan="2">Mumbai</td>
            <td>Krishna Street</td>
            <td>200</td>
            <td>850</td>
            <td>1</td>
        </tr>
        <tr>
            <td>Main Street</td>
            <td>500</td>
            <td>600</td>
            <td>4</td>
        </tr>
        <tr>
            <td rowspan="2">Surath</td>
            <td>New Street</td>
            <td>500</td>
            <td>600</td>
            <td>4</td>
        </tr>
        <tr>
            <td>Billa Street</td>
            <td>500</td>
            <td>600</td>
            <td>2</td>
        </tr>
        <tr>
            <td rowspan="2">2</td>
            <td rowspan="2">Alaska</td>
            <td rowspan="2">AKA Central</td>
            <td>New Street</td>
            <td>200</td>
            <td>210</td>
            <td>2</td>
        </tr>
        <tr>
            <td>Cross Street</td>
            <td>1000</td>
            <td>1050</td>
            <td>10</td>
        </tr>
    </table>
</br>
</br>
<table border = 1>
    <tr>
        <td rowspan="3">Day</td>
        <td colspan="3">Seminar</td>
    </tr>
    <tr>
            <td colspan="2">Schedule</td>
            <td rowspan="2">Topic</td>
        </tr>
    <tr>
        <td>Begin</td>
        <td>End</td>
    </tr>
    <tr>
        <td rowspan="2">Monday</td>
        <td rowspan="2">8 am</td>
        <td rowspan="2">5 pm</td>
        <td>Introduction to XML</td>
    </tr>
    <tr>
        <td>Validity : DTD and Relax NG</td>
    </tr>
    <tr>
        <td rowspan="3">Tuesday</td>
        <td>8 am</td>
        <td>11 am</td>
        <td rowspan="2">Xpath</td>
    </tr>
    <tr>
        <td>11 am</td>
        <td>2 pm</td>
    </tr>
    <tr>
        <td>2 pm</td>
        <td>5 pm</td>
        <td>XSL Transformations</td>
    </tr>
    <tr>
        <td>Wednesday</td>
        <td>8 am</td>
        <td>12 pm</td>
        <td>XSL Formatting Objects</td>
    </tr>
</table>
    </html>
</html> -->







<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Classroom Quiz ‚Äî Single File</title>
<style>
/* ===== Reset & base ===== */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;background:linear-gradient(180deg,#f7fbff 0%,#f0f6ff 100%);color:#0b1220}
a{color:inherit;text-decoration:none}
button{cursor:pointer}

/* ===== Layout ===== */
.app{display:flex;min-height:100vh;position:relative}
/* COLLAPSED left icon only (fixed) */
.sidebar-mini {
  position:fixed; top:18px; left:18px; z-index:120;
  width:56px; height:56px; border-radius:999px;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(135deg,#4f46e5,#06b6d4); color:#fff; font-weight:800;
  box-shadow:0 8px 24px rgba(15,23,42,0.12);
  cursor:pointer;
}

/* Full overlay sidebar (hidden by default) */
.sidebar-overlay {
  position:fixed; left:18px; top:86px; width:300px; max-width:86vw; bottom:18px;
  background:#fff;border-radius:12px;padding:18px;border:1px solid #eef2f7; box-shadow:0 18px 40px rgba(2,6,23,0.12);
  display:none; flex-direction:column; gap:12px; z-index:121; overflow:auto;
}

/* visible class toggles overlay */
.sidebar-overlay.visible { display:flex; }

/* sidebar content (kept similar to original style) */
.brand{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#4f46e5,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.brand-text h1{margin:0;font-size:16px}
.brand-text p{margin:0;font-size:12px;color:#6b7280}
.collapse-btn{background:transparent;border:none;font-size:18px;padding:6px;color:#334155}
.nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.nav button{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;border:none;background:transparent;text-align:left;font-weight:700;color:#0b1220}
.nav button:hover{background:#f1f6ff}
.nav button.active{background:linear-gradient(90deg,#eff6ff,#f0f9ff)}
.profile-box{margin-top:auto;padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef2ff}

/* Main */
.main{flex:1;padding:20px;margin-left:0}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.title{font-size:20px;font-weight:800}
.subtitle{color:#6b7280;font-size:13px}
.card{background:#fff;border-radius:12px;padding:16px;border:1px solid #eef2f7;box-shadow:0 8px 24px rgba(15,23,42,0.03);margin-bottom:14px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}

/* Forms and small UI */
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;margin-top:8px}
label{font-weight:700;font-size:13px;color:#0b1220;display:block;margin-top:10px}
.btn{background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;border:none;font-weight:700}
.btn.ghost{background:transparent;color:#2563eb;border:1px solid #dbeafe}
.small{font-size:13px;color:#475569}
.muted{color:#6b7280;font-size:13px}

/* Quiz UI */
.question-box{border-radius:10px;padding:12px;background:linear-gradient(180deg,#fbfdff,#fff);border:1px solid #eef4ff;margin-bottom:10px}
.options{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.option{padding:10px;border-radius:8px;border:1px solid #eef2f7;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.option.selected{background:#eff6ff;border-color:#60a5fa}
.progress{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;margin-top:8px}
.progress span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#4f46e5);width:0%}

/* Timer pill */
.timer-pill{padding:8px 12px;border-radius:999px;border:1px solid #e6eef8;background:#fff;display:inline-block;font-weight:800}

/* Table */
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}

/* Leaderboard graph container */
.leader-graph { margin-top:12px; padding:12px; border-radius:8px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid #eef2f7; }
.leader-graph svg { width:100%; height:220px; display:block; }

/* Responsive */
@media(max-width:980px){.grid{grid-template-columns:1fr}.sidebar-overlay{left:10px;right:10px;top:86px;width:auto}}

/* Small helpers */
.right{margin-left:auto}
.center{text-align:center}

/* AUTH overlay styles */
#authOverlay{position:fixed;inset:0;background:rgba(2,6,23,0.35);display:flex;align-items:center;justify-content:center;z-index:140}
.auth-card{width:920px;max-width:96%;display:grid;grid-template-columns:1fr 1fr;gap:18px}
.auth-section{padding:20px;background:#fff;border-radius:10px}
.auth-section h2{margin:0 0 6px}
.auth-hint{color:#6b7280;font-size:13px;margin-top:8px}
.small-note{color:#64748b;font-size:13px;margin-top:8px}
</style>
</head>
<body>

<!-- COLLAPSED icon (top-left) -->
<div id="sidebarMini" class="sidebar-mini" title="Open menu">CQ</div>

<!-- Full overlay sidebar (hidden until clicked) -->
<div id="sidebarOverlay" class="sidebar-overlay" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div class="brand">
      <div class="logo">CQ</div>
      <div class="brand-text"><h1>Quiz Portal</h1><p class="muted">Live classroom quizzes</p></div>
    </div>
    <button id="closeSidebar" class="collapse-btn" title="Close">‚úï</button>
  </div>

  <nav class="nav" id="navListOverlay">
    <button class="nav-btn active" id="nav_dashboard" onclick="showPanel('dashboard')"><span class="icon">üè†</span><span class="label">Dashboard</span></button>
    <button class="nav-btn" id="nav_profile" onclick="showPanel('profile')"><span class="icon">üë§</span><span class="label">Profile</span></button>
    <button class="nav-btn" id="nav_quiz" onclick="showPanel('quiz')"><span class="icon">üß†</span><span class="label" id="nav_quiz_label">Take / Create Quiz</span></button>
    <button class="nav-btn" id="nav_leader" onclick="showPanel('leader')"><span class="icon">üèÜ</span><span class="label">Leaderboard</span></button>
    <button class="nav-btn" id="nav_analytics" onclick="showPanel('analytics')"><span class="icon">üìä</span><span class="label">Analytics</span></button>
  </nav>

  <div class="profile-box" id="sidebarProfileOverlay">
    <div style="display:flex;align-items:center;gap:12px">
      <div id="sbAvatarOverlay" style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#06b6d4,#4f46e5);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800">U</div>
      <div><div id="sbNameOverlay" style="font-weight:800">Guest</div><div class="small" id="sbRoleOverlay">‚Äî</div></div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button class="btn flat" onclick="logout()">Logout</button>
      <button class="btn ghost" onclick="copyShareLink()">Share</button>
    </div>
  </div>
</div>

<!-- ===== AUTH OVERLAY (dynamic fields) ===== -->
<div id="authOverlay">
  <div class="auth-card">
    <!-- Login Section -->
    <div class="auth-section">
      <h2>Login</h2>
      <p class="muted">Enter credentials to continue</p>

      <label>Role</label>
      <select id="loginRole" onchange="updateLoginFields()">
        <option value="student">Student</option>
        <option value="faculty">Faculty</option>
      </select>

      <label id="loginIdLabel">Name or Enrollment</label>
      <input id="loginId" placeholder="Name or Enrollment">

      <!-- Dynamic ID field (enrollment or faculty id) appears if role requires) -->
      <div id="loginExtraWrap" style="display:none">
        <label id="loginExtraLabel">Enrollment No</label>
        <input id="loginExtra" placeholder="">
      </div>

      <label>Password</label>
      <input id="loginPass" placeholder="Password" type="password">

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="btn ghost" onclick="showSignupSection()">Create New Account</button>
      </div>

      <p class="small-note">Select role to reveal the required fields (Enrollment for students, Faculty ID for faculty).</p>
    </div>

    <!-- Signup Section -->
    <div class="auth-section" id="signupSection">
      <h2>Create Account</h2>
      <p class="muted">Sign up as Student or Faculty</p>

      <label>Role</label>
      <select id="signupRole" onchange="updateSignupFields()">
        <option value="student">Student</option>
        <option value="faculty">Faculty</option>
      </select>

      <label>Name</label>
      <input id="signupName" placeholder="Full name">

      <div id="signupExtraWrap">
        <label id="signupExtraLabel">Enrollment No</label>
        <input id="signupExtra" placeholder="Enrollment number (students)">
      </div>

      <label>Password</label>
      <input id="signupPass" type="password" placeholder="Create a password">

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" onclick="doSignup()">Create account</button>
        <button class="btn ghost" onclick="showLoginSection()">Back to login</button>
      </div>

      <p class="small-note">Sign up fields change automatically based on selected role.</p>
    </div>
  </div>
</div>

<!-- ===== APP SHELL (main content) ===== -->
<div class="app" id="appRoot" style="display:none">
  <main class="main">
    <div class="topbar">
      <div><div class="title" id="mainTitle">Dashboard</div><div class="subtitle" id="mainSubtitle">Overview</div></div>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="liveBadge" style="display:none;background:#eef2ff;padding:6px 10px;border-radius:999px;color:#1e40af;font-weight:800">LIVE</div>
        <div class="timer-pill" id="globalTimer" style="display:none">‚è± <span id="globalTimerText">00:00</span></div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="panel_dashboard" class="card grid">
      <div>
        <h3 id="welcome">Welcome, Student</h3>
        <p class="muted" id="dashSub">Last quiz summary and active quizzes</p>

        <div style="margin-top:12px" class="card">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="font-weight:800;font-size:20px" id="stat_quizzes">0</div>
            <div><div class="muted">Quizzes Published</div></div>
            <div style="width:12px"></div>
            <div style="font-weight:800;font-size:20px" id="stat_submissions">0</div>
            <div><div class="muted">Total Submissions</div></div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h4>Active Quiz</h4>
          <div id="activeQuizArea" class="muted">No live quiz</div>
          <div style="margin-top:8px">
            <button class="btn" onclick="refreshAll()">Refresh</button>
            <button class="btn ghost" onclick="simulateOpen()">Open new tab</button>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h4>Last Attempt</h4>
          <div id="lastAttemptArea" class="muted">No attempts</div>
        </div>
        <div style="height:12px"></div>
        <div class="card">
          <h4>Your Quick Stats</h4>
          <div id="quickStats" class="muted">Loading...</div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="panel_profile" class="card" style="display:none">
      <h3>Profile</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div>
          <p><strong>Name:</strong> <span id="profileName"></span></p>
          <p><strong>Role:</strong> <span id="profileRole"></span></p>
          <p><strong>Enrollment / ID:</strong> <span id="profileEnroll"></span></p>
        </div>
        <div>
          <p><strong>Quizzes created:</strong> <span id="profileCreated">0</span></p>
          <p><strong>Quizzes taken:</strong> <span id="profileTaken">0</span></p>
          <p><strong>Accuracy:</strong> <span id="profileAcc">0%</span></p>
        </div>
      </div>
      <div style="margin-top:12px">
        <button class="logout-btn btn" onclick="logout()">Logout</button>
      </div>
    </section>

    <!-- QUIZ PANEL -->
    <section id="panel_quiz" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3>Quizzes</h3><div class="muted">Create (faculty) or take (student)</div></div>
        <div><button class="btn" id="btnPublishLive" style="display:none" onclick="publishLatest()">Publish Latest Live</button></div>
      </div>

      <div id="quizContent" style="margin-top:12px">
        <!-- Faculty Create -->
        <div id="facultyCreate" style="display:none">
          <h4>Create quiz</h4>
          <label>Quiz Title</label><input id="createTitle" placeholder="Title">
          <label>Duration (seconds)</label><input id="createDuration" type="number" value="300">
          <div id="questionBuilder" style="margin-top:12px"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn" onclick="addQuestion()">+ Add Question</button>
            <button class="btn ghost" onclick="saveQuiz()">Save Quiz</button>
            <button class="btn ghost" onclick="saveAndPublish()">Save & Publish</button>
          </div>
          <div style="margin-top:14px">
            <h4>Saved quizzes</h4><div id="savedQuizList" class="muted">No quizzes</div>
          </div>
        </div>

        <!-- Student list -->
        <div id="studentList" style="display:none">
          <h4>Available Quizzes</h4><div id="availableQuizzes" class="muted">Loading...</div>
        </div>

        <!-- Play area -->
        <div id="playArea" style="display:none;margin-top:12px">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="flex:1"><div style="font-weight:800" id="playTitle">Quiz</div><div class="small muted" id="playMeta">teacher</div></div>
            <div class="timer-pill" id="playTimerPill">‚è± <span id="playTimerText">05:00</span></div>
          </div>
          <div class="card" style="margin-top:12px">
            <div id="questionIndex" style="font-weight:700">Q1 / N</div>
            <div id="questionText" style="margin-top:8px">Question text</div>
            <div class="options" id="questionOptions"></div>
            <div class="progress"><span id="progressBar"></span></div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn ghost" onclick="prevQuestion()">Prev</button>
              <button class="btn ghost" onclick="nextQuestion()">Next</button>
              <div class="right"><button class="btn" onclick="submitAttempt()">Submit Quiz</button></div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- LEADERBOARD -->
    <section id="panel_leader" class="card" style="display:none">
      <h3>Leaderboard</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="small">Select quiz</div>
        <select id="leaderSelect" style="width:320px;margin-left:8px" onchange="renderLeaderboard()"><option value="__overall">Overall</option></select>
        <div class="right small muted">Auto-refresh</div>
      </div>

      <div style="margin-top:12px">
        <!-- Graph -->
        <div class="leader-graph" id="leaderGraphWrap">
          <svg id="leaderGraphSVG" viewBox="0 0 600 220" preserveAspectRatio="none"></svg>
          <div style="font-size:13px;color:#475569;margin-top:8px">Bar graph shows top students (total correct). It updates after quiz submission.</div>
        </div>

        <!-- Table -->
        <div style="margin-top:12px">
          <table>
            <thead><tr><th>Rank</th><th>Name</th><th>Score</th><th>Time(s)</th><th>When</th></tr></thead>
            <tbody id="leaderTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="panel_analytics" class="card" style="display:none">
      <h3>Analytics</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div class="card"><h4>Your Attempts (30d)</h4><div id="analyticsAttempts" class="muted">Loading...</div></div>
        <div class="card"><h4>Accuracy & Streaks</h4><div id="analyticsMetrics" class="muted">Loading...</div></div>
      </div>
    </section>

  </main>
</div>

<script>
/* ===========================
   localStorage keys & helpers
   =========================== */
const LS = { USERS:'cq_users_v2', QUIZZES:'cq_quizzes_v2', SUBS:'cq_subs_v2', ACTIVE:'cq_active_v2', CUR:'cq_current_v2' };
const uid = ()=> 'id-'+Math.random().toString(36).slice(2,9);
const nowSec = ()=> Math.floor(Date.now()/1000);
const fmtTime = s => { if(s<0)s=0; const m=Math.floor(s/60).toString().padStart(2,'0'); const sec=(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; };
const load = k => JSON.parse(localStorage.getItem(k) || 'null');
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));

if(!load(LS.USERS)) save(LS.USERS,[]);
if(!load(LS.QUIZZES)) save(LS.QUIZZES,[]);
if(!load(LS.SUBS)) save(LS.SUBS,[]);

/* App state */
let currentUser = load(LS.CUR) || null;
let PLAY = null; // active play state for student
let PLAY_INTERVAL = null;
let GLOBAL_INTERVAL = null;
let leaderAuto = null;

/* ===== Sidebar open/close logic ===== */
const mini = document.getElementById('sidebarMini');
const overlay = document.getElementById('sidebarOverlay');
const closeSidebarBtn = document.getElementById('closeSidebar');
mini.addEventListener('click', ()=> {
  // show overlay
  overlay.classList.add('visible');
  overlay.setAttribute('aria-hidden','false');
});
closeSidebarBtn.addEventListener('click', ()=> {
  overlay.classList.remove('visible');
  overlay.setAttribute('aria-hidden','true');
});
// also close overlay when clicking outside it
document.addEventListener('click', (e) => {
  if (!overlay.classList.contains('visible')) return;
  const inside = overlay.contains(e.target) || mini.contains(e.target);
  if (!inside) {
    overlay.classList.remove('visible');
    overlay.setAttribute('aria-hidden','true');
  }
});

/* ===== AUTH dynamic fields logic ===== */
function updateLoginFields(){
  const role = document.getElementById('loginRole').value;
  const extraWrap = document.getElementById('loginExtraWrap');
  const extraLabel = document.getElementById('loginExtraLabel');
  const extraInput = document.getElementById('loginExtra');
  if(role === 'student'){
    extraWrap.style.display = 'block';
    extraLabel.innerText = 'Enrollment No';
    extraInput.placeholder = 'Enrollment number';
  } else {
    extraWrap.style.display = 'block';
    extraLabel.innerText = 'Faculty ID';
    extraInput.placeholder = 'Faculty ID';
  }
}

function updateSignupFields(){
  const role = document.getElementById('signupRole').value;
  const wrap = document.getElementById('signupExtraWrap');
  const label = document.getElementById('signupExtraLabel');
  const input = document.getElementById('signupExtra');
  if(role === 'student'){
    wrap.style.display = 'block';
    label.innerText = 'Enrollment No';
    input.placeholder = 'Enrollment number (students)';
  } else {
    wrap.style.display = 'block';
    label.innerText = 'Faculty ID';
    input.placeholder = 'Faculty ID (faculty)';
  }
}

function showSignupSection(){ document.getElementById('signupName').focus(); }
function showLoginSection(){ document.getElementById('loginId').focus(); }

/* ===== AUTH actions ===== */
function doSignup(){
  const role = document.getElementById('signupRole').value;
  const name = document.getElementById('signupName').value.trim();
  const extra = document.getElementById('signupExtra').value.trim();
  const pass = document.getElementById('signupPass').value;
  if(!name || !pass) return alert('Name & password required');
  if(role==='student' && !extra) return alert('Enrollment required for students');
  if(role==='faculty' && !extra) return alert('Faculty ID required for faculty');
  const users = load(LS.USERS) || [];
  if(users.find(u => u.name === name || (u.enroll && u.enroll === extra) || (u.facId && u.facId === extra))) return alert('User exists');
  const user = { name, password: pass, role };
  if(role === 'student') user.enroll = extra;
  else user.facId = extra;
  users.push(user);
  save(LS.USERS, users);
  currentUser = { name, enroll: user.enroll, role };
  save(LS.CUR, currentUser);
  openApp();
}

function doLogin(){
  const role = document.getElementById('loginRole').value;
  const id = document.getElementById('loginId').value.trim();
  const extra = document.getElementById('loginExtra').value.trim();
  const pass = document.getElementById('loginPass').value;
  if(!id || !pass) return alert('Complete credentials');
  const users = load(LS.USERS) || [];
  let found = null;
  if(role === 'student'){
    found = users.find(u => u.role === 'student' && ((u.name === id) || (u.enroll === id) || (u.enroll === extra)) && u.password === pass);
  } else {
    found = users.find(u => u.role === 'faculty' && ((u.name === id) || (u.facId === id) || (u.facId === extra)) && u.password === pass);
  }
  if(!found) return alert('Invalid credentials');
  currentUser = { name: found.name, enroll: found.enroll, role: found.role };
  save(LS.CUR, currentUser);
  openApp();
}

/* Logout */
function logout(){
  if(!confirm('Logout?')) return;
  localStorage.removeItem(LS.CUR);
  currentUser = null;
  location.reload();
}

/* share link */
function copyShareLink(){ navigator.clipboard?.writeText(location.href).then(()=> alert('Link copied')); }
function simulateOpen(){ window.open(location.href,'_blank'); }

/* ===== OPEN APP AFTER LOGIN ===== */
function openApp(){
  document.getElementById('authOverlay').style.display='none';
  document.getElementById('appRoot').style.display='flex';
  // overlay sidebar profile mirrors
  document.getElementById('sbNameOverlay').innerText = currentUser.name;
  document.getElementById('sbRoleOverlay').innerText = currentUser.role;
  document.getElementById('sbAvatarOverlay').innerText = currentUser.name.charAt(0).toUpperCase();
  document.getElementById('welcome').innerText = `Welcome, ${currentUser.name}`;
  document.getElementById('profileName').innerText = currentUser.name;
  document.getElementById('profileRole').innerText = currentUser.role;
  document.getElementById('profileEnroll').innerText = currentUser.enroll || '-';
  setRoleUI();
  refreshAll();
  window.addEventListener('storage', storageHandler);
}

/* ===== Role UI toggles ===== */
function setRoleUI(){
  const role = currentUser.role;
  document.getElementById('nav_quiz_label').innerText = role === 'faculty' ? 'Create Quiz' : 'Take Quiz';
  document.getElementById('facultyCreate').style.display = role === 'faculty' ? 'block' : 'none';
  document.getElementById('studentList').style.display = role === 'student' ? 'block' : 'none';
  document.getElementById('btnPublishLive').style.display = role === 'faculty' ? 'inline-block' : 'none';
}

/* ===== Panels & core functionality (kept intact) ===== */
if(!load(LS.USERS)) save(LS.USERS,[]);
if(!load(LS.QUIZZES)) save(LS.QUIZZES,[]);
if(!load(LS.SUBS)) save(LS.SUBS,[]);

function showPanel(panel){
  // hide auth sidebar overlay (if open) when navigating
  overlay.classList.remove('visible');
  ['panel_dashboard','panel_profile','panel_quiz','panel_leader','panel_analytics'].forEach(id => document.getElementById(id).style.display='none');
  document.getElementById('panel_'+panel).style.display='block';
  // update active nav buttons inside overlay
  document.querySelectorAll('#navListOverlay .nav-btn').forEach(b => b.classList.remove('active'));
  const navBtn = document.getElementById('nav_'+panel);
  if(navBtn) navBtn.classList.add('active');
  document.getElementById('mainTitle').innerText = panel.charAt(0).toUpperCase()+panel.slice(1);
  if(panel==='quiz') loadQuizPanel();
  if(panel==='leader') { renderLeaderboard(); renderLeaderboardGraph(); startLeaderAuto(); }
  else stopLeaderAuto();
  if(panel==='analytics') renderAnalytics();
}

function updateStats(){
  const quizzes = load(LS.QUIZZES) || [];
  const subs = load(LS.SUBS) || [];
  document.getElementById('stat_quizzes').innerText = quizzes.length;
  document.getElementById('stat_submissions').innerText = subs.length;
}

function renderLastAttempt(){
  const subs = load(LS.SUBS) || [];
  if(!currentUser) return;
  const my = subs.filter(s=>s.studentEnroll === currentUser.enroll).sort((a,b)=>b.timestamp - a.timestamp)[0];
  const area = document.getElementById('lastAttemptArea');
  if(!my){ area.innerHTML = '<div class="muted">No attempts yet</div>'; return; }
  area.innerHTML = `<div style="font-weight:800">${my.quizTitle}</div><div class="small muted">Score: ${my.score}/${my.total} ‚Ä¢ ${my.timeTaken}s ‚Ä¢ ${new Date(my.timestamp*1000).toLocaleString()}</div>`;
  document.getElementById('quickStats').innerHTML = `Last: ${my.score}/${my.total}<br>${new Date(my.timestamp*1000).toLocaleString()}`;
}

/* Quiz creation */
function addQuestion(){
  const idx = document.querySelectorAll('.qb').length + 1;
  const container = document.getElementById('questionBuilder');
  const div = document.createElement('div'); div.className='qb card'; div.style.marginTop='8px';
  div.innerHTML = `
    <label>Question ${idx}</label>
    <input class="qb-text" placeholder="Question text">
    <input class="qb-opt" placeholder="Option A">
    <input class="qb-opt" placeholder="Option B">
    <input class="qb-opt" placeholder="Option C">
    <input class="qb-opt" placeholder="Option D">
    <label>Correct option (A/B/C/D)</label>
    <input class="qb-correct" placeholder="A">
    <div style="text-align:right;margin-top:8px"><button class="btn ghost" onclick="this.closest('.qb').remove()">Remove</button></div>
  `;
  container.appendChild(div);
}

function saveQuiz(){
  const title = document.getElementById('createTitle').value.trim();
  const duration = parseInt(document.getElementById('createDuration').value,10) || 300;
  if(!title) return alert('Enter title');
  const wrappers = Array.from(document.querySelectorAll('.qb'));
  if(!wrappers.length) return alert('Add questions');
  const questions = wrappers.map(w => {
    const text = w.querySelector('.qb-text').value.trim();
    const opts = Array.from(w.querySelectorAll('.qb-opt')).map(i=>i.value.trim());
    const correct = (w.querySelector('.qb-correct').value || 'A').toUpperCase();
    return {text,options:opts,correct};
  });
  for(const q of questions) if(!q.text || q.options.some(o=>!o)) return alert('Fill all fields');
  const quizzes = load(LS.QUIZZES) || [];
  const id = uid();
  quizzes.push({id,title,duration,questions,createdBy:currentUser.name,createdAt:nowSec(),published:false});
  save(LS.QUIZZES, quizzes);
  alert('Quiz saved');
  localStorage.setItem('cq_quizzes_updated_at', Date.now());
  loadQuizPanel();
  updateStats();
}

function saveAndPublish(){ saveQuiz(); publishLatest(); }
function publishLatest(){
  const quizzes = load(LS.QUIZZES) || [];
  const last = quizzes.slice().reverse().find(q=>q.createdBy === currentUser.name);
  if(!last) return alert('No quiz found');
  if(!confirm(`Publish "${last.title}" live for ${last.duration}s?`)) return;
  publishQuiz(last.id);
}

function publishQuiz(quizId){
  const quizzes = load(LS.QUIZZES) || [];
  const q = quizzes.find(x=>x.id===quizId);
  if(!q) return alert('Quiz not found');
  q.published = true;
  save(LS.QUIZZES, quizzes);
  const now = nowSec();
  const active = {quizId:q.id,startedAt:now,endsAt:now + q.duration,publishedBy:currentUser.name};
  save(LS.ACTIVE, active);
  localStorage.setItem('cq_active_updated_at', Date.now());
  alert('Published live');
  loadQuizPanel();
  updateStats();
}

function loadQuizPanel(){
  setRoleUI();
  const quizzes = load(LS.QUIZZES) || [];
  const myList = quizzes.filter(q => q.createdBy === currentUser.name);
  const savedArea = document.getElementById('savedQuizList');
  if(myList.length){
    let html = '<ul style="padding-left:16px">';
    myList.forEach(q => html += `<li style="margin-bottom:8px"><strong>${q.title}</strong> ‚Ä¢ ${q.questions.length} q ‚Ä¢ ${q.duration}s ‚Ä¢ ${q.published ? 'Published' : 'Draft'} <button class="btn ghost" onclick="publishQuiz('${q.id}')">Publish</button></li>`);
    html += '</ul>';
    savedArea.innerHTML = html;
  } else savedArea.innerHTML = '<div class="muted">No quizzes</div>';

  const available = quizzes.filter(q => q.published === true);
  const availArea = document.getElementById('availableQuizzes');
  if(available.length){
    let html = '<ul style="padding-left:16px">';
    available.forEach(q => html += `<li style="margin-bottom:8px"><strong>${q.title}</strong> ‚Ä¢ ${q.questions.length} q ‚Ä¢ ${q.duration}s ‚Ä¢ by ${q.createdBy} <button class="btn" onclick="joinQuiz('${q.id}')">Join</button></li>`);
    html += '</ul>';
    availArea.innerHTML = html;
  } else availArea.innerHTML = '<div class="muted">No published quizzes</div>';

  document.getElementById('btnPublishLive').style.display = currentUser.role === 'faculty' ? 'inline-block' : 'none';
  renderActiveQuizInfo();
}

function joinQuiz(quizId){ startPlay(quizId); }

function renderActiveQuizInfo(){
  const active = load(LS.ACTIVE);
  const area = document.getElementById('activeQuizArea');
  if(!active){ area.innerHTML = '<div class="muted">No live quiz</div>'; document.getElementById('liveBadge').style.display='none'; document.getElementById('globalTimer').style.display='none'; return; }
  const quizzes = load(LS.QUIZZES) || [];
  const q = quizzes.find(x=>x.id===active.quizId);
  if(!q){ area.innerHTML = '<div class="muted">No live quiz</div>'; return; }
  const left = Math.max(0, active.endsAt - nowSec());
  area.innerHTML = `<div style="font-weight:800">${q.title}</div><div class="small muted">by ${active.publishedBy} ‚Ä¢ ends in ${left}s</div><div style="margin-top:8px"><button class="btn" onclick="startPlay('${q.id}')">Join Live</button></div>`;
  document.getElementById('liveBadge').style.display='inline-block';
  document.getElementById('globalTimer').style.display='inline-block';
  updateGlobalTimer();
}

function updateGlobalTimer(){
  clearInterval(GLOBAL_INTERVAL);
  const active = load(LS.ACTIVE);
  if(!active){ document.getElementById('globalTimer').style.display='none'; return; }
  GLOBAL_INTERVAL = setInterval(()=>{
    const left = Math.max(0, active.endsAt - nowSec());
    document.getElementById('globalTimerText').innerText = fmtTime(left);
    if(left <= 0){ clearInterval(GLOBAL_INTERVAL); localStorage.removeItem(LS.ACTIVE); localStorage.setItem('cq_active_updated_at', Date.now()); renderActiveQuizInfo(); }
  },1000);
}

/* Play state */
function startPlay(quizId){
  const quizzes = load(LS.QUIZZES) || [];
  const q = quizzes.find(x=>x.id===quizId);
  if(!q) return alert('Quiz not found');
  PLAY = { quizId: q.id, quizTitle:q.title, questions:q.questions, answers:Array(q.questions.length).fill(null), index:0, remaining:q.duration, total:q.duration, startedAt:nowSec() };
  showPanel('quiz'); document.getElementById('facultyCreate').style.display='none'; document.getElementById('studentList').style.display='none'; document.getElementById('playArea').style.display='block';
  renderPlayQuestion(); startPlayTimer();
}

function renderPlayQuestion(){
  if(!PLAY) return;
  const idx = PLAY.index;
  const q = PLAY.questions[idx];
  document.getElementById('playTitle').innerText = PLAY.quizTitle;
  document.getElementById('playMeta').innerText = `Q${idx+1} / ${PLAY.questions.length}`;
  document.getElementById('questionIndex').innerText = `Q${idx+1} / ${PLAY.questions.length}`;
  document.getElementById('questionText').innerText = q.text;
  const opts = document.getElementById('questionOptions'); opts.innerHTML='';
  q.options.forEach((opt,i)=>{
    const label = String.fromCharCode(65+i);
    const div = document.createElement('div');
    div.className = 'option' + (PLAY.answers[idx] === label ? ' selected' : '');
    div.innerHTML = `<div>${label}. ${opt}</div><div class="small">${PLAY.answers[idx] === label ? 'Selected':''}</div>`;
    div.onclick = ()=> { PLAY.answers[idx] = label; renderPlayQuestion(); };
    opts.appendChild(div);
  });
  const percent = Math.round(((idx+1)/PLAY.questions.length)*100);
  document.getElementById('progressBar').style.width = percent + '%';
}

function nextQuestion(){ if(!PLAY) return; if(PLAY.index < PLAY.questions.length -1){ PLAY.index++; renderPlayQuestion(); } }
function prevQuestion(){ if(!PLAY) return; if(PLAY.index > 0){ PLAY.index--; renderPlayQuestion(); } }

function startPlayTimer(){
  if(!PLAY) return;
  clearInterval(PLAY_INTERVAL);
  document.getElementById('playTimerText').innerText = fmtTime(PLAY.remaining);
  PLAY_INTERVAL = setInterval(()=>{
    PLAY.remaining--;
    document.getElementById('playTimerText').innerText = fmtTime(PLAY.remaining);
    if(PLAY.remaining <= 0){ clearInterval(PLAY_INTERVAL); autoSubmit(); }
  },1000);
}

function autoSubmit(){ alert('Time up ‚Äî auto-submitting'); finalizeAttempt(); }
function submitAttempt(){ if(!PLAY) return; if(!confirm('Submit now?')) return; finalizeAttempt(); }

function finalizeAttempt(){
  clearInterval(PLAY_INTERVAL);
  const qcount = PLAY.questions.length;
  let score = 0;
  PLAY.questions.forEach((qq,i)=> { if(PLAY.answers[i] === qq.correct) score++; });
  const timeTaken = PLAY.total - PLAY.remaining;
  const subs = load(LS.SUBS) || [];
  subs.push({ id:uid(), quizId:PLAY.quizId, quizTitle:PLAY.quizTitle, studentName:currentUser.name, studentEnroll:currentUser.enroll, answers:PLAY.answers, score, total:qcount, timeTaken, timestamp:nowSec() });
  save(LS.SUBS, subs);
  localStorage.setItem('cq_subs_updated_at', Date.now());
  // update leaderboard graph/table immediately
  renderLeaderboard();
  renderLeaderboardGraph();
  alert(`Submitted: ${score} / ${qcount}`);
  PLAY = null;
  showPanel('dashboard');
  refreshAll();
}

/* Leaderboard functions */
function populateLeaderSelect(){
  const sel = document.getElementById('leaderSelect');
  const quizzes = load(LS.QUIZZES) || [];
  sel.innerHTML = '<option value="__overall">Overall</option>';
  quizzes.forEach(q => sel.innerHTML += `<option value="${q.id}">${q.title}</option>`);
}

function renderLeaderboard(){
  populateLeaderSelect();
  const subs = load(LS.SUBS) || [];
  const sel = document.getElementById('leaderSelect').value;
  const table = document.getElementById('leaderTable'); table.innerHTML='';
  if(!subs.length) return table.innerHTML = '<tr><td colspan=5 class="muted">No submissions</td></tr>';
  if(sel === '__overall'){
    const agg = {};
    subs.forEach(s => {
      if(!agg[s.studentEnroll]) agg[s.studentEnroll] = {name:s.studentName,enroll:s.studentEnroll,total:0,time:0,last:s.timestamp};
      agg[s.studentEnroll].total += s.score;
      agg[s.studentEnroll].time += s.timeTaken;
      if(s.timestamp > agg[s.studentEnroll].last) agg[s.studentEnroll].last = s.timestamp;
    });
    const arr = Object.values(agg).sort((a,b)=> b.total - a.total || a.time - b.time);
    arr.forEach((r,i) => { table.innerHTML += `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.total}</td><td>${r.time}</td><td class="small">${new Date(r.last*1000).toLocaleString()}</td></tr>`; });
  } else {
    const qsubs = subs.filter(s => s.quizId === sel).sort((a,b)=> b.score - a.score || a.timeTaken - b.timeTaken);
    if(!qsubs.length) return table.innerHTML = '<tr><td colspan=5 class="muted">No submissions for this quiz</td></tr>';
    qsubs.forEach((s,i) => table.innerHTML += `<tr><td>${i+1}</td><td>${s.studentName}</td><td>${s.score}/${s.total}</td><td>${s.timeTaken}s</td><td class="small">${new Date(s.timestamp*1000).toLocaleString()}</td></tr>`);
  }
}

/* Graph rendering for leaderboard (SVG bar chart) */
function renderLeaderboardGraph(){
  const svg = document.getElementById('leaderGraphSVG');
  svg.innerHTML = '';
  const subs = load(LS.SUBS) || [];
  if(!subs.length){
    // show empty state
    svg.innerHTML = `<g><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#94a3b8">No submissions yet</text></g>`;
    return;
  }
  // aggregate totals per student (overall)
  const agg = {};
  subs.forEach(s => {
    if(!agg[s.studentEnroll]) agg[s.studentEnroll] = {name:s.studentName, total:0};
    agg[s.studentEnroll].total += s.score;
  });
  let arr = Object.values(agg).sort((a,b)=> b.total - a.total);
  // show top 6
  arr = arr.slice(0,6);
  const max = Math.max(...arr.map(a=>a.total), 1);
  // svg viewBox width 600 height 220
  const vw = 600, vh = 220;
  const gap = 12;
  const barW = (vw - (arr.length+1)*gap) / Math.max(1, arr.length);
  // draw bars and labels
  let x = gap;
  arr.forEach((item, idx) => {
    const h = Math.round((item.total / max) * (vh - 60)); // leave space for labels
    const y = vh - 40 - h;
    // bar
    const colorA = ['#60a5fa','#4f46e5','#06b6d4','#7c3aed','#0ea5a0','#ef4444'][idx % 6];
    svg.innerHTML += `<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="6" fill="${colorA}"></rect>`;
    // value text above bar
    svg.innerHTML += `<text x="${x + barW/2}" y="${y - 6}" font-size="12" text-anchor="middle" fill="#0b1220">${item.total}</text>`;
    // name label
    const short = item.name.length > 10 ? item.name.slice(0,10)+'‚Ä¶' : item.name;
    svg.innerHTML += `<text x="${x + barW/2}" y="${vh - 18}" font-size="12" text-anchor="middle" fill="#475569">${short}</text>`;
    x += barW + gap;
  });
}

/* Auto refresh leaderboard while visible */
function startLeaderAuto(){ if(leaderAuto) clearInterval(leaderAuto); leaderAuto = setInterval(()=> { renderLeaderboard(); renderLeaderboardGraph(); }, 4000); }
function stopLeaderAuto(){ if(leaderAuto) clearInterval(leaderAuto); leaderAuto = null; }

/* Analytics */
function renderAnalytics(){
  const subs = load(LS.SUBS) || [];
  const my = subs.filter(s=> s.studentEnroll === currentUser.enroll).sort((a,b)=>b.timestamp-a.timestamp);
  const last30 = my.filter(s => s.timestamp >= nowSec() - 30*24*3600);
  let html = '<ul style="padding-left:16px">';
  last30.forEach(s => html += `<li>${s.quizTitle} ‚Äî ${s.score}/${s.total} ‚Äî ${new Date(s.timestamp*1000).toLocaleString()}</li>`);
  html += '</ul>';
  document.getElementById('analyticsAttempts').innerHTML = last30.length ? html : '<div class="muted">No attempts</div>';
  const correct = my.reduce((a,b)=> a + b.score, 0);
  const tot = my.reduce((a,b)=> a + b.total, 0);
  const acc = tot ? Math.round((correct/tot)*100) : 0;
  let streak = 0;
  const daySet = [...new Set(my.map(s => new Date(s.timestamp*1000).toDateString()))];
  let d = new Date(); d.setHours(0,0,0,0);
  while(daySet.includes(d.toDateString())){ streak++; d.setDate(d.getDate()-1); }
  document.getElementById('analyticsMetrics').innerHTML = `Accuracy: <strong>${acc}%</strong><br>Attempts: <strong>${my.length}</strong><br>Streak: <strong>${streak}</strong>`;
}

/* Storage handler to reflect cross-tab updates */
function storageHandler(e){
  if(!e.key) return;
  if(e.key === 'cq_active_updated_at') renderActiveQuizInfo();
  if(e.key === 'cq_subs_updated_at') { updateStats(); renderLastAttempt(); renderLeaderboard(); renderLeaderboardGraph(); renderActiveQuizInfo(); }
  if(e.key === 'cq_quizzes_updated_at') { loadQuizPanel(); updateStats(); renderActiveQuizInfo(); populateLeaderSelect(); }
}

/* Refresh helpers */
function refreshAll(){ updateStats(); renderLastAttempt(); loadQuizPanel(); renderLeaderboard(); renderLeaderboardGraph(); renderAnalytics(); }

/* Init on load */
(function init(){
  const saved = load(LS.CUR);
  updateLoginFields(); updateSignupFields();
  // start with overlay hidden and only mini icon visible (prevents overlapping)
  if(saved){ currentUser = saved; openApp(); } else { document.getElementById('appRoot').style.display='none'; document.getElementById('authOverlay').style.display='flex'; }
  updateStats(); renderActiveQuizInfo(); populateLeaderSelect(); renderLeaderboardGraph();
})();

</script>
</body>
</html>
